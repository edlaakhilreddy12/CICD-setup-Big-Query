# CI/CD Pipeline: Deploy to BigQuery
# 
# Learning Guide - What's happening here:
# 
# This YAML file defines a GitHub Actions workflow.
# GitHub Actions reads this file and executes the steps automatically.
#
# Key concepts:
# - 'name': What you see in the GitHub Actions tab
# - 'on': When this workflow triggers (push, pull_request, schedule, etc.)
# - 'jobs': Groups of steps that run together
# - 'steps': Individual commands to execute
# - 'env': Environment variables available to all steps
# - 'secrets': Secure values stored in GitHub (like your service account key)

name: Deploy to BigQuery

# TRIGGERS - When should this pipeline run?
on:
  push:
    branches:
      - main          # Run on every push to main branch (PRODUCTION)
      - dev           # Run on every push to dev branch (DEVELOPMENT)
    paths:
      - 'data/**'     # Only run if data files change
      - 'sql/**'      # Only run if SQL files change
      - 'scripts/**'  # Only run if Python scripts change
      - 'config/**'   # Only run if config changes
      - '.github/workflows/**'  # Only run if workflow changes
  
  pull_request:
    branches:
      - main          # Run on pull requests to main (for testing before prod)
      - dev           # Run on pull requests to dev (for testing before dev)
  
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production

# ENVIRONMENT VARIABLES - Available to all jobs
env:
  PYTHON_VERSION: '3.10'
  
# JOBS - The actual work to be done
jobs:
  
  # JOB 1: Validate the code and data
  validate:
    name: Validate Data and Code
    runs-on: ubuntu-latest  # Run on Ubuntu Linux (free GitHub-hosted runner)
    
    steps:
      # STEP 1: Get the code from the repository
      - name: Checkout code
        uses: actions/checkout@v4
        # This downloads your repository code to the runner
        # It's usually the first step in any workflow
      
      # STEP 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache pip packages for faster runs
      
      # STEP 3: Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed successfully"
      
      # STEP 4: Validate CSV data format
      - name: Validate data files
        run: |
          echo "üîç Checking CSV files..."
          # Check if CSV files exist and have content
          if [ -f "data/sample_data.csv" ]; then
            echo "‚úÖ sample_data.csv found"
            lines=$(wc -l < data/sample_data.csv)
            echo "   Lines: $lines"
          else
            echo "‚ùå sample_data.csv not found!"
            exit 1
          fi
      
      # STEP 5: Validate schema files
      - name: Validate schema files
        run: |
          echo "üîç Checking schema files..."
          python -c "
          import json
          with open('data/schemas/table_schema.json', 'r') as f:
              schema = json.load(f)
              print(f'‚úÖ Schema valid with {len(schema)} fields')
          "
      
      # STEP 6: Check SQL syntax (basic validation)
      - name: Validate SQL files
        run: |
          echo "üîç Checking SQL files..."
          for sql_file in sql/*.sql; do
            echo "Checking $sql_file..."
            # Basic check - ensure file is not empty
            if [ -s "$sql_file" ]; then
              echo "‚úÖ $sql_file is valid"
            else
              echo "‚ùå $sql_file is empty!"
              exit 1
            fi
          done

  # JOB 2: Deploy to BigQuery
  # This job only runs if 'validate' job succeeds
  deploy:
    name: Deploy to BigQuery
    runs-on: ubuntu-latest
    needs: validate  # Wait for validation to complete successfully
    
    # Only run on main or dev branch (not on pull requests)
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name != 'pull_request'
    
    steps:
      # STEP 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # STEP 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # STEP 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # STEP 4: Determine environment and config file
      - name: Set environment configuration
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "config_file=config-prod.yaml" >> $GITHUB_OUTPUT
            echo "üè≠ Deploying to PRODUCTION environment"
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "config_file=config-dev.yaml" >> $GITHUB_OUTPUT
            echo "üîß Deploying to DEVELOPMENT environment"
          fi
      
      # STEP 5: Display deployment info
      - name: Show deployment configuration
        run: |
          echo "üìã Deployment Details:"
          echo "   Environment: ${{ steps.set-env.outputs.environment }}"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Config: ${{ steps.set-env.outputs.config_file }}"
          echo ""
          echo "üìÑ Configuration contents:"
          cat config/${{ steps.set-env.outputs.config_file }}
      
      # STEP 6: Authenticate with Google Cloud
      # This is where we use the service account key from GitHub Secrets
      - name: Set up Google Cloud authentication
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.SVC_BQ_CICD }}
        run: |
          echo "üîê Setting up Google Cloud authentication..."
          # The service account JSON is now available in the environment
          # The Python scripts will read it from the environment variable
          echo "‚úÖ Authentication configured"
      
      # STEP 7: Load data to BigQuery (with environment-specific config)
      - name: Load data to BigQuery
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.SVC_BQ_CICD }}
          CONFIG_FILE: ${{ steps.set-env.outputs.config_file }}
        run: |
          echo "üì§ Starting data load to BigQuery..."
          python scripts/load_data.py
          echo "‚úÖ Data loaded successfully"
      
      # STEP 8: Run transformations (with environment-specific config)
      - name: Run SQL transformations
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.SVC_BQ_CICD }}
          CONFIG_FILE: ${{ steps.set-env.outputs.config_file }}
        run: |
          echo "üîÑ Running SQL transformations..."
          python scripts/run_transformations.py
          echo "‚úÖ Transformations completed"
      
      # STEP 9: Generate deployment summary
      - name: Generate summary
        if: always()  # Run even if previous steps fail
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.set-env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment completed on:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Steps Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- Data validation" >> $GITHUB_STEP_SUMMARY
          echo "- Data loaded to BigQuery" >> $GITHUB_STEP_SUMMARY
          echo "- SQL transformations executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "üéâ **PRODUCTION** deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "üîß **DEVELOPMENT** deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi

  # JOB 3: Notify on failure (optional)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure()  # Only run if any previous job failed
    
    steps:
      - name: Report failure
        run: |
          echo "‚ùå Pipeline failed!"
          echo "Check the logs above for details."
          # In a real scenario, you could send Slack/email notifications here
          exit 1

# LEARNING NOTES:
#
# 1. Workflow Execution Order:
#    validate ‚Üí deploy ‚Üí notify-failure (if needed)
#
# 2. Common GitHub Actions Syntax:
#    ${{ ... }}        - Expression syntax for variables
#    secrets.NAME      - Access secure secrets
#    env.NAME          - Access environment variables
#    needs: [job]      - Wait for another job to complete
#    if: condition     - Conditional execution
#
# 3. Security Best Practices:
#    - Never commit secrets to code (use GitHub Secrets)
#    - Use minimal permissions for service accounts
#    - Only run deploys on main branch
#    - Validate data before deploying
#
# 4. Optimization Tips:
#    - Use caching for dependencies (cache: 'pip')
#    - Run validation before expensive operations
#    - Use 'paths' filter to avoid unnecessary runs
#    - Use 'needs' to create dependencies between jobs
#
# 5. Debugging:
#    - Check the Actions tab in GitHub to see logs
#    - Each step shows detailed output
#    - Failed steps are highlighted in red
#    - You can re-run failed workflows
